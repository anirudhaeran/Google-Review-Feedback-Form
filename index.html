<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leave Your Feedback</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #f4f4f9;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        text-align: center;
      }
      .container {
        background-color: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 400px;
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
      }
      .stars {
        font-size: 48px;
        cursor: pointer;
        color: #e0e0e0; /* Default color for unselected stars */
      }
      /* --- MODIFIED CSS FOR HOVER & SELECTED STATE --- */
      .star {
        transition: color 0.1s ease-in-out; /* Smooth transition for color change */
      }
      .star:hover,
      .star:hover ~ .star {
        /* Stars to the right of hovered star go back to default */
        color: #e0e0e0;
      }
      .star:hover,
        .stars:hover .star.selected, /* Ensure selected stars stay colored on hover */
        .stars:hover .star:hover {
        color: #ffc107; /* Color for hovered star */
      }
      .stars:hover .star:hover ~ .star {
        color: #e0e0e0; /* Stars to the right of hovered star (within hover group) */
      }
      /* Stars up to the hovered star get colored */
      .star:hover ~ .star {
        color: #e0e0e0;
      }
      .star:hover,
      .stars:hover .star:hover,
      .stars:hover .star:hover ~ .star.selected,
      .star.hovered {
        /* New class for dynamically applying hover style */
        color: #ffc107;
      }
      .star.selected,
      .star.selected ~ .star {
        /* All stars including and after selected are colored */
        color: #ffc107; /* Selected color */
      }
      /* --- END MODIFIED CSS --- */

      #feedback-form {
        display: none; /* Hidden by default */
        margin-top: 20px;
      }
      textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
        margin-bottom: 15px;
      }
      button {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: white;
        font-size: 18px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container" id="main-container">
      <div id="star-rating">
        <h1>How was your visit?</h1>
        <span class="stars" id="star-container">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </span>
      </div>

      <div id="feedback-form">
        <h2>We're sorry to hear that.</h2>
        <p>Please tell us what went wrong so we can improve.</p>
        <textarea
          id="feedback-text"
          placeholder="Your feedback is important to us..."
        ></textarea>
        <button id="submit-feedback">Submit Feedback</button>
      </div>
    </div>

    <script>
      // --- START: CUSTOMIZE THESE VALUES ---
      const GOOGLE_REVIEW_URL = "Your Google Review URL";
      const FEEDBACK_WEBHOOK_URL = "Your Feedback Webhook URL (n8n)"; // Renamed for clarity
      const CLICK_TRACKER_WEBHOOK_URL = "Your Click Tracker Webhook URL (n8n)"; // <<< 1. ADD THIS NEW WEBHOOK URL
      // --- END: CUSTOMIZE THESE VALUES ---

      let userRating = 0;

      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get("userId");

      // --- ADD THIS ENTIRE BLOCK FOR TRACKING ---
      window.onload = () => {
        if (userId) {
          fetch(CLICK_TRACKER_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: userId }),
          });
        }
      };
      // --- END OF TRACKING BLOCK ---

      const starContainer = document.getElementById("star-container");
      const stars = document.querySelectorAll(".star");

      // --- YOUR HOVER CODE (UNCHANGED) ---
      starContainer.addEventListener("mouseover", (event) => {
        const hoveredStar = event.target.closest(".star");
        if (hoveredStar) {
          const hoverValue = parseInt(hoveredStar.dataset.value);
          stars.forEach((star) => {
            if (parseInt(star.dataset.value) <= hoverValue) {
              star.classList.add("hovered");
            } else {
              star.classList.remove("hovered");
            }
          });
        }
      });

      starContainer.addEventListener("mouseout", () => {
        stars.forEach((star) => star.classList.remove("hovered"));
      });
      // --- END OF HOVER CODE ---

      stars.forEach((star) => {
        star.addEventListener("click", () => {
          userRating = parseInt(star.dataset.value);
          stars.forEach((s) => s.classList.remove("selected"));
          for (let i = 0; i < userRating; i++) {
            stars[i].classList.add("selected");
          }

          setTimeout(() => {
            if (userRating >= 4) {
              window.location.href = GOOGLE_REVIEW_URL;
            } else {
              document.getElementById("star-rating").style.display = "none";
              document.getElementById("feedback-form").style.display = "block";
            }
          }, 300);
        });
      });

      document
        .getElementById("submit-feedback")
        .addEventListener("click", () => {
          const feedbackText = document.getElementById("feedback-text").value;

          fetch(FEEDBACK_WEBHOOK_URL, {
            // Note: I renamed N8N_WEBHOOK_URL to be more specific
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              rating: userRating,
              feedback: feedbackText,
              userId: userId,
            }),
          }).then((response) => {
            if (response.ok) {
              document.getElementById("main-container").innerHTML =
                "<h1>Thank You!</h1><p>Your feedback has been received.</p>";
            } else {
              alert("There was an error submitting your feedback.");
            }
          });
        });
    </script>
  </body>
</html>
